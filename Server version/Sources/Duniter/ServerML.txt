(* 
Duniter: WotWizard.

Copyright (C) 2017 GérardMeunier

This program is free software; you can redistribute it and/or modify it under the terms of the GNU General Public License as published by the Free Software Foundation; either version 2 of the License, or (at your option) any later version.

This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License  for more details.

You should have received a copy of the GNU General Public License along with this program; if not, write to the Free Software Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
*)

MODULE DuniterServerML;
	
	

	IMPORT
		
		B := DuniterBlockchain, BA := DuniterBasic, E := DuniterEvents, L := DuniterLog, Converters, Dialog, Files, HostFiles, HostMenus, Services, TextViews, Views;
	
	CONST
		
		version = "2.8.6se";
		
		textConv = "CpcUtf8Conv.ExportUtf8";
		
		memberL = "MemberL.json";
	
	PROCEDURE StoreJson;
		
		VAR
			
			loc: Files.Locator;
			name: Files.Name;
			v: TextViews.View;
			res: INTEGER;
		
		BEGIN (*StoreJson*)
			L.log.Msg("Writing json");
			loc := Files.dir.This(""); L.log.Err(loc.res, "");
			v := E.JsonMembershipsEndsText();
			name := memberL;
			Views.Register(v, Views.dontAsk, loc, name, BA.utf8Conv, res);
			L.log.Err(res, name);
			L.log.Msg("End writing json");
		END StoreJson;
	
	(* Main procedure *)
	PROCEDURE Start*;
		
		CONST
			
			maxTriesNb = 100;
		
		VAR
			
			t: LONGINT;
			s: BA.TimeString;
			loc: Files.Locator;
			n: INTEGER;
			ss: Dialog.String;
		
		BEGIN (*Start*)
			t := Services.Ticks();
			B.UpdateAll;
			BA.TimeToString(Services.Ticks() - t, s);
			L.log.Msg("Total execution time: " + s);
			HostMenus.Exit;  (* End of WWServer.exe *)
		END Start;
	
	PROCEDURE Init;
		
		BEGIN (*Init*)
			HostFiles.IgnoreAsk;
			L.log.Msg("Version " + version);
			B.AddUpdateProc(StoreJson);
		END Init;
	
	BEGIN (*DuniterServerML*)
		Init;
	END DuniterServerML.

DuniterServerML.Start;
